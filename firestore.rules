
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Correctly checks the user profile of the person making the request.
    // This is allowed in write rules because it uses `request.auth.uid`.
    function isRequestingUserAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.userType == 'administrator';
    }
    
    function isNotChangingSensitiveFields() {
      // Users cannot change their own ID, email, or user type after creation.
      return request.resource.data.id == resource.data.id &&
             request.resource.data.email == resource.data.email &&
             request.resource.data.userType == resource.data.userType;
    }
    
    match /userProfiles/{userProfileId} {
      allow get: if isOwner(userProfileId) || isRequestingUserAdmin();
      allow list: if isRequestingUserAdmin();
      allow create: if isOwner(userProfileId) && 
                     request.resource.data.id == userProfileId &&
                     !exists(/databases/$(database)/documents/emails/$(request.resource.data.email));
      allow update: if isOwner(userProfileId) && isNotChangingSensitiveFields();
      allow delete: if isOwner(userProfileId) || isRequestingUserAdmin();

      match /digitalIdCards/{cardId} {
        allow get, list: if isOwner(userProfileId) || isRequestingUserAdmin();
        allow create: if isOwner(userProfileId) && request.resource.data.userProfileId == userProfileId;
        
        // CORRECTED UPDATE RULE:
        // - An owner can update any field EXCEPT 'cardStatus'.
        // - An admin can update any field on any card.
        allow update: if (isOwner(userProfileId) && !('cardStatus' in request.resource.data.diff(resource.data))) || isRequestingUserAdmin();
                       
        allow delete: if isOwner(userProfileId) || isRequestingUserAdmin();
      }
    }
    
    match /emails/{emailId} {
      allow read, list, update, delete: if false;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
    }
  }
}
